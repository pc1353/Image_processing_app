
---

# Image Processing Backend

This repository contains an asynchronous image processing system built with FastAPI. The system accepts a CSV file containing product details and image URLs, processes the images asynchronously (compressing them by 50% quality), stores the processed images and product data in a PostgreSQL database, and allows you to download a generated output CSV. Optionally, a webhook callback can be triggered upon processing completion.

## Table of Contents

- [Features](#features)
- [Architecture](#architecture)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Configuration](#configuration)
- [Usage](#usage)
  - [Running the Application](#running-the-application)
  - [API Endpoints](#api-endpoints)
- [Testing](#testing)
- [Docker Deployment](#docker-deployment)
- [License](#license)

## Features

- **CSV Upload API:**  
  Accepts CSV files with product data and image URLs. Validates CSV format and returns a unique request ID.

- **Asynchronous Image Processing:**  
  Processes images in the background by compressing them by 50% quality.

- **Database Storage:**  
  Stores processing requests and product details in a PostgreSQL database.

- **Output CSV Generation:**  
  Generates an output CSV file containing both input and output image URLs.

- **Webhook Notification (Optional):**  
  Notifies an external webhook endpoint once processing is complete.

## Architecture

The system comprises the following components:

- **API Server (FastAPI):** Handles CSV uploads, status queries, and CSV downloads.
- **Asynchronous Worker:** Processes the CSV, downloads, and compresses images.
- **PostgreSQL Database:** Stores processing request details and product data.
- **Static File Storage:** Stores processed images.
- **Webhook Receiver:** Optionally receives notifications upon processing completion.

For a visual overview, please refer to the [technical documentation](#technical-design-document).

## Prerequisites

- **Python 3.12** (or newer)
- **PostgreSQL** running locally  
  *Make sure PostgreSQL is set up and accessible on your localhost before running `main.py`.*

## Installation

1. **Clone the Repository:**

   ```bash
   git clone https://github.com/your-username/image-processing-backend.git
   cd image-processing-backend
   ```

2. **Create a Virtual Environment and Activate It:**

   ```bash
   python -m venv venv
   source venv/bin/activate  # On Windows use: venv\Scripts\activate
   ```

3. **Install Dependencies:**

   ```bash
   pip install -r requirements.txt
   ```

## Configuration

Create a `.env` file in the root of the repository with the following content. This file configures the environment variables for your project:

```dotenv
# .env file sample

# PostgreSQL connection string (adjust credentials as needed)
DATABASE_URL=postgresql://user:password@localhost/dbname

# Directory where processed images will be stored
PROCESSED_IMAGES_DIR=processed_images
```

*Note: Do not commit sensitive data (like real credentials) to GitHub. Use environment variable management solutions for production.*

## Usage

### Running the Application

1. **Ensure PostgreSQL is Running:**

   Make sure that your PostgreSQL server is up and running on your localhost and that the credentials in your `.env` file are correct.

2. **Initialize the Database:**

   Before starting the server for the first time, initialize the database tables by running:

   ```bash
   python init_db.py
   ```

3. **Start the FastAPI Server:**

   Run the following command to start the application using Uvicorn:

   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```

4. **Access the API Documentation:**

   Once the server is running, navigate to [http://localhost:8000/docs](http://localhost:8000/docs) to view the interactive API documentation generated by FastAPI.

### API Endpoints

- **Upload CSV:**  
  `POST /upload`  
  Accepts a CSV file (and an optional `webhook_url` field as form data).  
  **Example cURL:**

  ```bash
  curl --location 'http://127.0.0.1:8000/upload' \
    --form 'file=@"/path/to/your/test.csv"' \
    --form 'webhook_url=https://your-webhook-url'
  ```

- **Check Processing Status:**  
  `GET /status/{request_id}`  
  Query the current processing status using the unique request ID.

- **Download Output CSV:**  
  `GET /download/{request_id}`  
  Download the output CSV file containing both input and output image URLs.

## Testing

- **Webhook Testing:**  
  - Use services like [RequestBin](https://requestbin.com/) or [Webhook.site](https://webhook.site/) to simulate a webhook receiver. Provide the generated URL as the `webhook_url` when uploading a CSV and monitor for incoming webhook notifications.

- **API Testing:**  
  - Use tools like [Postman](https://www.postman.com) or cURL to test all endpoints. The FastAPI documentation at `/docs` provides an interactive interface for quick testing.

  - Here is the public collection of API endpoints for the application [PublicPostmanCollection](https://www.postman.com/maintenance-physicist-38949414/image-processing-app/collection/ucbq1jz/image-processing-app?action=share&creator=27739144)

## Docker Deployment

To containerize the application, a `Dockerfile` is provided. Follow these steps:

1. **Build the Docker Image:**

   ```bash
   docker build -t image-processing-backend .
   ```

2. **Run the Docker Container:**

   ```bash
   docker run -d -p 8000:8000 --env-file .env image-processing-backend
   ```

*Make sure your PostgreSQL instance is accessible from within the Docker container or consider running PostgreSQL in another container and linking them via a Docker network.*